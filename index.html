<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <title>CKEditor5 Local Translation Demo</title>
  <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.1.1/ckeditor5.css">
  <link rel="stylesheet" href="demo/styles.css">
  
  <script type="importmap">
{
  "imports": {
    "ckeditor5": "https://cdn.ckeditor.com/ckeditor5/43.1.1/ckeditor5.js"
  }
}
  </script>

  <!-- Preload transformers.js environment -->
  <script type="module">
    import { env, pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.1';

    // Detect WebGPU availability on page load
    const hasWebGPU = typeof navigator !== 'undefined' && navigator.gpu ? true : false;
    window.useWebGPU = hasWebGPU;

    console.log('[DEBUG] WebGPU detection:', { available: hasWebGPU });

    // Configure transformers.js to use Hugging Face Hub
    env.allowRemoteModels = true;
    env.allowLocalModels = false;

    window.transformersPipeline = pipeline;
    window.transformersEnv = env;

    console.log('[DEBUG] transformers.js v3 loaded, pipeline:', typeof pipeline);
    console.log('[DEBUG] transformers.js v3 env configured, allowRemoteModels:', env.allowRemoteModels);
  </script>

  <style>
    .webgpu-banner {
      display: none;
      padding: 12px 20px;
      font-size: 13px;
      border-bottom: 1px solid;
    }
    .webgpu-banner.visible {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .webgpu-banner.success {
      background: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .webgpu-banner.warning {
      background: #fff3cd;
      color: #856404;
      border-color: #ffeeba;
    }

    .toggle-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      color: #333;
    }

    .toggle-track {
      width: 50px;
      height: 26px;
      background: #6c757d;
      border-radius: 13px;
      position: relative;
      transition: background 0.3s;
    }

    .toggle-track.webgpu {
      background: #198754;
    }

    .toggle-thumb {
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-track.webgpu .toggle-thumb {
      left: 26px;
    }

    .toggle-label {
      font-weight: 500;
    }

    .toggle-label.wasm {
      color: #6c757d;
    }

    .toggle-label.webgpu {
      color: #198754;
    }
  </style>
</head>
<body>

  <div class="demo-container">
    <aside class="sidebar">
      <h3>Translation Settings</h3>
      
      <div class="setting-group">
        <label for="model-select">Model:</label>
        <select id="model-select"></select>
        <div id="model-info" class="model-info"></div>
        <div id="external-api-warning" class="external-api-warning" style="display: none;">
          <div class="warning-icon">&#9432;</div>
          <div class="warning-content">
            <strong>External AI API</strong>
            <p>This model uses an external AI service. Your text will be sent to Puter AI for translation. Users cover their own API costs through the User-Pays model.</p>
            <p class="warning-note">No local model loading required - ready to use immediately.</p>
          </div>
        </div>
      </div>

      <div class="setting-group">
        <label for="source-language">Source Language:</label>
        <select id="source-language">
          <option value="en">English</option>
          <option value="fi">Finnish</option>
          <option value="sv">Swedish</option>
          <option value="no">Norwegian</option>
          <option value="da">Danish</option>
          <option value="de">German</option>
          <option value="fr">French</option>
          <option value="es">Spanish</option>
          <option value="pt">Portuguese</option>
          <option value="it">Italian</option>
          <option value="nl">Dutch</option>
          <option value="pl">Polish</option>
          <option value="ru">Russian</option>
          <option value="ja">Japanese</option>
          <option value="zh">Chinese</option>
          <option value="ko">Korean</option>
          <option value="ar">Arabic</option>
          <option value="hi">Hindi</option>
          <option value="tr">Turkish</option>
          <option value="vi">Vietnamese</option>
        </select>
      </div>

      <div class="setting-group">
        <label>Custom Model:</label>
        <input type="text" id="custom-model" placeholder="e.g., Xenova/mymodel">
        <button id="apply-custom-model" class="secondary">Apply Custom</button>
      </div>

      <div class="setting-group status-section">
        <h3>Status</h3>
        <div id="status" class="status">Ready</div>
      </div>

      <div class="setting-group">
        <h3>Model Loading</h3>
        <button id="load-model" class="primary">Load Model</button>
        <div class="progress-container">
          <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="progress-text" class="progress-text">0%</div>
      </div>

      <div class="setting-group">
        <label>Backend:</label>
        <div class="toggle-container">
          <button id="backend-toggle" class="toggle-btn">
            <span class="toggle-track">
              <span class="toggle-thumb"></span>
            </span>
            <span class="toggle-label">WASM</span>
          </button>
          <small id="backend-status" style="color: #666; font-size: 11px;">Auto-detected</small>
        </div>
      </div>

      <div class="setting-group">
        <button id="clear-cache" class="secondary">Clear Model Cache</button>
        <small style="color: #666; font-size: 11px;">Clear cached models to force fresh download</small>
      </div>

      <div class="setting-group">
        <h3>Test</h3>
        <button id="test-translation" class="secondary">Test Translation</button>
        <div id="test-result" class="test-result"></div>
      </div>

      <div class="setting-group">
        <div id="translation-progress" class="translation-progress" style="display: none;">
          <div class="spinner"></div>
          <span>Translation in progress...</span>
        </div>
        <div id="translation-done" class="translation-done">
          <div class="checkmark">&#10003;</div>
          <span>Translation done</span>
        </div>
      </div>

    </aside>

    <main class="editor-container">
      <div class="demo-warning">
        <strong>Warning:</strong> This loads an AI translation model directly in your browser. 
        Large models may use significant memory and could slow or crash your browser.
      </div>

      <div id="editor-container"></div>
      <div id="editor-original" style="display: none;">
        <p>Hello! This is a demonstration of local translation in CKEditor5 using <strong>transformers.js</strong>.</p>
        <br/>
        <p>Click the Translate button, and select language.</p>
        <p>The translation happens entirely in your browser using WebGPU or WebAssembly.</p>
      </div>
      <div id="editor-loading" class="editor-loading" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Loading CKEditor5...</p>
        <p class="loading-hint">If this takes more than 10 seconds, check the browser console (F12) for errors.</p>
      </div>
      <div id="editor-error" class="editor-error" style="display: none;">
        <h3>Error Loading Editor</h3>
        <p>Failed to initialize CKEditor5. Please check the browser console (F12) for details.</p>
        <p class="error-hint">Common issues:</p>
        <ul>
          <li>Browser incompatible (need Firefox 146+, Chrome 89+, or Safari 16.4+)</li>
          <li>JavaScript modules blocked by security settings</li>
          <li>CORS/COOP policy blocking CDN resources</li>
        </ul>
      </div>
      <div class="demo-info">
        <strong>About This Demo</strong>
        <p>This is a proof-of-concept CKEditor5 plugin that runs translation models <b>100% in your browser</b> using WebGPU and WebAssembly via transformers.js. <b>No API requests are sent to any server—all processing happens locally on your device.</b></p>
        <p>Models are downloaded from Hugging Face on first use. Translation quality and speed depend on your device's capabilities and the selected model variant.</p>
        <p><b>Warning:</b> Translation models can consume significant memory (several hundred MB or even several GB). If you experience browser slowdowns or crashes, try a smaller model variant or restart the browser.</p>
        <p><b>Security Note:</b> This demo has an XSS vulnerability. The translation model's output is inserted directly into the editor without sanitization.</p>
        <p>WebGPU provides GPU acceleration when supported by the browser. Use the backend toggle to switch to WASM if models fail to load. Models are downloaded from Hugging Face and cached in the browser for subsequent use.</p>
        <p>This project demonstrates the feasibility of local, privacy-preserving translation directly in the browser without relying on external translation services.</p>
        <p><b>Tip:</b> WebGPU isn't always faster—smaller models like NLLB often run faster with WASM. Experiment with both backends to find what works best for your device.</p>
      </div>
    </main>
  </div>

  <script type="module" src="demo/demo.js"></script>
</body>
</html>
